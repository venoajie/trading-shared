# .github/workflows/release.yml
# This workflow validates the code and creates a new Git tag and GitHub Release
# upon a push to the main branch. It does NOT publish to a package registry.

name: Create Python Library Release

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validate:
    name: Lint & Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Lint with Ruff
        run: |
          ruff check .
          ruff format --check .
      - name: Test with Pytest and generate coverage report
        run: |
          pytest \
            --cov=src \
            --cov-report=xml \
            --cov-fail-under=90

  release:
    # ANALYSIS: The job is renamed to reflect its new purpose.
    name: Tag and Release to GitHub
    needs: validate
    runs-on: ubuntu-latest
    if: github.event.name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      # ANALYSIS: The 'packages: write' permission is removed. It is no longer
      # needed, adhering to the principle of least privilege.
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install release dependencies
        run: python -m pip install --upgrade pip python-semantic-release build
      - name: Configure Git for CI/CD
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      # ANALYSIS: The step name and command are updated for clarity.
      - name: Create New Version and Release
        env:
          # ANALYSIS: The token is correctly named GH_TOKEN for semantic-release.
          # The obsolete TWINE_* variables have been removed.
          GH_TOKEN: ${{ secrets.GH_PAT }}
        # ANALYSIS: The '--force-new-release' flag is removed as it's a debug tool.
        # The 'publish' command is still correct, as it orchestrates the entire
        # release process (version bump, changelog, tagging, GitHub Release).
        run: semantic-release publish --verbose